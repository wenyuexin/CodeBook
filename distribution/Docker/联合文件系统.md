# Docker联合文件系统

联合文件系统（UnionFS ）是一种轻量级的高性能**分层文件系统**，它支持将文件系统中的修改信息作为一次提交，并层层叠加，同时可以将不同目录挂载到同一个虚拟文件系统下，应用看到的是挂载的最终结果。联合文件系统是实现 Docker 镜像的技术基础。

**Docker 镜像可以通过分层来进行继承**。例如，用户基于基础镜像（用来生成其他镜像的基础，往往没有父镜像）来制作各种不同的应用镜像。 这些镜像共享同一个基础镜像层，提高了存储效率。 此外，当用户改变了一个Docker 镜像（比如升级程序到新的版本），则建一个新的层（ layer ）。因此，用户不用替换整个原镜像或者重新建立，只需要添加新层即可。用户分发镜像的时候，也只需要分发被改动的新层内容（增量部分） 这让 Docker
像管理变得十分轻量和快速。

<br>

### Docker 存储原理

Docker 目前通过插件化方式支持多种文件系统后端。

例如，Debian/Ubuntu 上成熟的 AUFS（Another Union File System）就是一种联合文件系统实现。AUFS支持为每一个成员目录（类似 Git 的分支）设定只读（readonly）、读写（ readwrite ）或写出（ whiteout-able ）权限。同时AUFS里有一个类似**分层**的概念，**对只读权限的分支可以逻辑上进行增量地修改（不影响只读部分的）**。

Docker 镜像自身就是由多个文件层组成，每一层有基于 容的唯一的编号（层 ID）。可以通过 docker history 查看一个镜像由哪些层组成。

当 Docker 利用镜像启动一个容器时，将在镜像文件系统的最顶端再挂载一个新的可读写层给容器。 容器中的内容更新将会发生在可读写层。 当所操作对象位于较深的某层时，需要先复制到最上层的可读写层。 当数据对象较大时，往往意味着较差的IO 性能。因此，对于 IO 敏感型应用，一般推荐将容器修改的数据通过 volume 方式挂载，而不是直接修改镜像内数据。

### Docker 存储结构

所有的镜像和容器都存储都在 Docker 指定的存储目录下，例如，Ubuntu宿主系统的默认存储路径为`/var/lib/docker`。在这个目录下面，存储由 Docker 镜像和容器运行相关的文件和目录。

如果使用 AUFS 存储后端，则最关键的就是 aufs 目录，保存 Docker 镜像和容器相关数据和信息。包括 layers、diff 和 mnt 三个子目录：

- layers 子目录包含**层属性文件**，用来保存各个镜像层的元数据：某镜像的某层下面包括哪些层。
- diff 子目录包含**层内容子目录**，用来保存所有镜像层的内容数据。
- mnt 子目录下面的子目录是**各个容器最终的挂载点**，所有相关的 AUFS 层在这里挂载到一起，形成最终效果。一个运行中容器的根文件系统就挂载在这下面的子目录上。

### 多种文件系统

Docker 目前支持的联合文件系统种类包括 AUFS 、btrfs、Device Mapper、overlay、overlay2、vfs、zfs等。

<br>

---

1. 《Docker技术入门与实战（第三版）》杨保华，机械工业出版社，第17章